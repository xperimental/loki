apiVersion: v1
data:
  config.yaml: |
    ---
    auth_enabled: true
    chunk_store_config:
      chunk_cache_config:
        embedded_cache:
          enabled: true
          max_size_mb: 500
    common:
      storage:
        s3:
          s3: https://s3.eu-central-1.amazonaws.com
          bucketnames: example-bucket
          region: eu-central-1
          access_key_id: ${AWS_ACCESS_KEY_ID}
          secret_access_key: ${AWS_ACCESS_KEY_SECRET}
          s3forcepathstyle: true
      compactor_grpc_address: lokistack-dev-compactor-grpc.openshift-logging.svc.cluster.local:9095
      ring:
        kvstore:
          store: memberlist
        heartbeat_period: 5s
        heartbeat_timeout: 1m
        instance_port: 9095
    compactor:
      compaction_interval: 2h
      working_directory: /tmp/loki/compactor
    frontend:
      tail_proxy_url: https://lokistack-dev-querier-http.openshift-logging.svc.cluster.local:3100
      tail_tls_config:
        tls_cert_path: /var/run/tls/http/server/tls.crt
        tls_key_path: /var/run/tls/http/server/tls.key
        tls_ca_path: /var/run/ca/service-ca.crt
        tls_server_name: lokistack-dev-querier-http.openshift-logging.svc.cluster.local
        tls_cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
        tls_min_version: VersionTLS12
      compress_responses: true
      max_outstanding_per_tenant: 4096
      log_queries_longer_than: 5s
    frontend_worker:
      frontend_address: lokistack-dev-query-frontend-grpc.openshift-logging.svc.cluster.local:9095
      grpc_client_config:
        max_send_msg_size: 104857600
        tls_enabled: true
        tls_cert_path: /var/run/tls/grpc/server/tls.crt
        tls_key_path: /var/run/tls/grpc/server/tls.key
        tls_ca_path: /var/run/ca/service-ca.crt
        tls_server_name: lokistack-dev-query-frontend-grpc.openshift-logging.svc.cluster.local
        tls_cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
        tls_min_version: VersionTLS12
      match_max_concurrent: true
    ingester:
      chunk_block_size: 262144
      chunk_encoding: snappy
      chunk_idle_period: 1h
      chunk_retain_period: 5m
      chunk_target_size: 2097152
      flush_op_timeout: 10m
      max_chunk_age: 2h
      lifecycler:
        final_sleep: 0s
        join_after: 30s
        num_tokens: 512
        ring:
          replication_factor: 1
      max_transfer_retries: 0
      wal:
        enabled: true
        dir: /tmp/wal
        replay_memory_ceiling: 0
    ingester_client:
      grpc_client_config:
        max_recv_msg_size: 67108864
        tls_enabled: true
        tls_cert_path: /var/run/tls/grpc/server/tls.crt
        tls_key_path: /var/run/tls/grpc/server/tls.key
        tls_ca_path: /var/run/ca/service-ca.crt
        tls_server_name: lokistack-dev-ingester-grpc.openshift-logging.svc.cluster.local
        tls_cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
        tls_min_version: VersionTLS12
      remote_timeout: 1s
    # NOTE: Keep the order of keys as in Loki docs
    # to enable easy diffs when vendoring newer
    # Loki releases.
    # (See https://grafana.com/docs/loki/latest/configuration/#limits_config)
    #
    # Values for not exposed fields are taken from the grafana/loki production
    # configuration manifests.
    # (See https://github.com/grafana/loki/blob/main/production/ksonnet/loki/config.libsonnet)
    limits_config:
      ingestion_rate_strategy: global
      ingestion_rate_mb: 4
      ingestion_burst_size_mb: 6
      max_label_name_length: 1024
      max_label_value_length: 2048
      max_label_names_per_series: 30
      reject_old_samples: true
      reject_old_samples_max_age: 168h
      creation_grace_period: 10m
      enforce_metric_name: false
      # Keep max_streams_per_user always to 0 to default
      # using max_global_streams_per_user always.
      # (See https://github.com/grafana/loki/blob/main/pkg/ingester/limiter.go#L73)
      max_streams_per_user: 0
      max_line_size: 256000
      max_entries_limit_per_query: 5000
      max_global_streams_per_user: 0
      max_chunks_per_query: 2000000
      max_query_length: 721h
      max_query_parallelism: 32
      tsdb_max_query_parallelism: 512
      max_query_series: 500
      cardinality_limit: 100000
      max_streams_matchers_per_query: 1000
      query_timeout: 3m
      max_cache_freshness_per_query: 10m
      per_stream_rate_limit: 3MB
      per_stream_rate_limit_burst: 15MB
      split_queries_by_interval: 30m
      allow_structured_metadata: true
    memberlist:
      abort_if_cluster_join_fails: true
      advertise_port: 7946
      bind_port: 7946
      join_members:
        - lokistack-dev-gossip-ring.openshift-logging.svc.cluster.local:7946
      max_join_backoff: 1m
      max_join_retries: 10
      min_join_backoff: 1s
    querier:
      engine:
        max_look_back_period: 30s
      extra_query_delay: 0s
      query_ingesters_within: 3h
      tail_max_duration: 1h
      max_concurrent: 0
    compactor_grpc_client:
      tls_enabled: true
      tls_cert_path: /var/run/tls/grpc/server/tls.crt
      tls_key_path: /var/run/tls/grpc/server/tls.key
      tls_ca_path: /var/run/ca/service-ca.crt
      tls_server_name: lokistack-dev-compactor-grpc.openshift-logging.svc.cluster.local
      tls_cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
      tls_min_version: VersionTLS12
    query_range:
      align_queries_with_step: true
      cache_results: true
      max_retries: 5
      results_cache:
        cache:
          embedded_cache:
            enabled: true
            max_size_mb: 500
      parallelise_shardable_queries: true
    schema_config:
      configs:
        - from: "2022-06-01"
          index:
            period: 24h
            prefix: index_
          object_store: s3
          schema: v12
          store: boltdb-shipper

    ruler:
      enable_api: true
      enable_sharding: true
      alertmanager_url: https://_web._tcp.alertmanager-operated.openshift-monitoring.svc
      enable_alertmanager_v2: true
      enable_alertmanager_discovery: true
      alertmanager_refresh_interval: 1m
      wal:
        dir: /tmp/wal
        truncate_frequency: 60m
        min_age: 5m
        max_age: 4h
      rule_path: /tmp/loki
      storage:
        type: local
        local:
          directory: /tmp/rules
      ring:
        kvstore:
          store: memberlist
      ruler_client:
        tls_enabled: true
        tls_cert_path: /var/run/tls/grpc/server/tls.crt
        tls_key_path: /var/run/tls/grpc/server/tls.key
        tls_ca_path: /var/run/ca/service-ca.crt
        tls_server_name: lokistack-dev-ruler-grpc.openshift-logging.svc.cluster.local
        tls_cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
        tls_min_version: VersionTLS12

    internal_server:
      enable: true
      http_listen_address: ""
      tls_min_version: VersionTLS12
      tls_cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
      http_tls_config:
        cert_file: /var/run/tls/http/server/tls.crt
        key_file: /var/run/tls/http/server/tls.key
    server:
      graceful_shutdown_timeout: 5s
      grpc_server_min_time_between_pings: '10s'
      grpc_server_ping_without_stream_allowed: true
      grpc_server_max_concurrent_streams: 1000
      grpc_server_max_recv_msg_size: 104857600
      grpc_server_max_send_msg_size: 104857600
      http_listen_port: 3100
      http_server_idle_timeout: 30s
      http_server_read_timeout: 18s
      http_server_write_timeout: 4m0s
      tls_min_version: VersionTLS12
      tls_cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
      http_tls_config:
        cert_file: /var/run/tls/http/server/tls.crt
        key_file: /var/run/tls/http/server/tls.key
        client_auth_type: RequireAndVerifyClientCert
        client_ca_file: /var/run/ca/service-ca.crt
      grpc_tls_config:
        cert_file: /var/run/tls/grpc/server/tls.crt
        key_file: /var/run/tls/grpc/server/tls.key
        client_auth_type: RequireAndVerifyClientCert
        client_ca_file: /var/run/ca/service-ca.crt
      log_level: info
    storage_config:
      boltdb_shipper:
        active_index_directory: /tmp/loki/index
        cache_location: /tmp/loki/index_cache
        cache_ttl: 24h
        resync_interval: 5m
        shared_store: s3
        index_gateway_client:
          server_address: dns:///lokistack-dev-index-gateway-grpc.openshift-logging.svc.cluster.local:9095
          grpc_client_config:
            tls_enabled: true
            tls_cert_path: /var/run/tls/grpc/server/tls.crt
            tls_key_path: /var/run/tls/grpc/server/tls.key
            tls_ca_path: /var/run/ca/service-ca.crt
            tls_server_name: lokistack-dev-index-gateway-grpc.openshift-logging.svc.cluster.local
            tls_cipher_suites: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
            tls_min_version: VersionTLS12
    tracing:
      enabled: false
    analytics:
      reporting_enabled: false
  runtime-config.yaml: |-
    ---
    overrides:
      application:
        ruler_alertmanager_config:
          alertmanager_url: https://_web._tcp.alertmanager-operated.openshift-user-workload-monitoring.svc
          enable_alertmanager_v2: true
          enable_alertmanager_discovery: true
          alertmanager_refresh_interval: 1m
          alertmanager_client:
            tls_ca_path: /var/run/ca/alertmanager/service-ca.crt
            tls_server_name: alertmanager-user-workload.openshift-user-workload-monitoring.svc.cluster.local
            type: Bearer
            credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token
kind: ConfigMap
metadata:
  creationTimestamp: null
  labels:
    app.kubernetes.io/created-by: lokistack-controller
    app.kubernetes.io/instance: lokistack-dev
    app.kubernetes.io/managed-by: lokistack-controller
    app.kubernetes.io/name: lokistack
  name: lokistack-dev-config
